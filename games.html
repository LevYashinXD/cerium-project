<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerium | Supported Games</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root{--color-background:#050505;--color-heading:#fff;--color-text:#e0e0e0;--color-card-bg:rgba(255,255,255,.05);--color-card-border:rgba(255,255,255,.1);--color-card-border-hover:rgba(255,255,255,.2);--primary-gradient:linear-gradient(90deg,#fff,#888);--color-glow:rgba(255,255,255,.3);--color-status-up:#00ff7f;--color-status-down:#ff3366;--color-status-caution:#ffd700;--header-height:80px;--font-family:'Inter',sans-serif;--border-radius:16px;--transition-speed:.4s;--transition-curve:cubic-bezier(0.16,1,0.3,1)}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth;scroll-padding-top:var(--header-height)}body{font-family:var(--font-family);background-color:var(--color-background);color:var(--color-text);line-height:1.7;overflow-x:hidden;background-image:radial-gradient(circle at 20% 20%,rgba(255,255,255,.04),transparent 35%),radial-gradient(circle at 80% 70%,rgba(255,255,255,.04),transparent 35%);position:relative}body.no-scroll{overflow:hidden}body::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" width="80" height="80"%3E%3Crect fill="%23050505" width="80" height="80"%3E%3C/rect%3E%3Cg fill-opacity="0.1"%3E%3Ccircle fill="%23FFFFFF" cx="40" cy="40" r="5"%3E%3C/circle%3E%3C/g%3E%3C/svg%3E');background-size:50px 50px;opacity:.05;z-index:-2;animation:pan-background 60s linear infinite}@keyframes pan-background{from{background-position:0% 0%}to{background-position:100% 100%}}@keyframes pulse-status{0%{box-shadow:0 0 0 0 rgba(0,255,127,.6)}70%{box-shadow:0 0 0 12px transparent}100%{box-shadow:0 0 0 0 transparent}}@keyframes preloader-pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:.8}}@keyframes hero-core-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes btn-shine{to{transform:translateX(120%) skewX(-25deg)}}@keyframes reveal-up{from{opacity:0;transform:translateY(50px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}@keyframes fade-in{from{opacity:0}to{opacity:1}}@keyframes fade-out{from{opacity:1}to{opacity:0}}@keyframes slide-up-and-fade-out{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-50px)}}@keyframes modal-fade-in{from{opacity:0;transform:translateY(-20px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}@keyframes skeleton-loading{0%{background-position:-200px 0}100%{background-position:calc(200px + 100%) 0}}#preloader,#login-wall,#welcome-transition{display:flex;align-items:center;justify-content:center;position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;background-color:var(--color-background);transition:opacity .5s ease,visibility .5s ease}#login-wall,#welcome-transition,#main-content{opacity:0;visibility:hidden}body.state-preloading #preloader{opacity:1;visibility:visible}body.state-login #login-wall{opacity:1;visibility:visible;animation:fade-in .5s ease forwards}body.state-welcome #welcome-transition{opacity:1;visibility:visible;animation:fade-in .5s ease forwards}body.state-authenticated #main-content{opacity:1;visibility:visible;animation:fade-in .5s ease forwards}#preloader.hidden{opacity:0;visibility:hidden}#preloader .preloader-logo{font-size:2.5rem;font-weight:800;color:var(--color-heading);animation:preloader-pulse 2s infinite ease-in-out}#login-wall .login-container{text-align:center;max-width:500px;padding:20px}#login-wall .login-card{padding:50px 60px;animation:reveal-up 1s var(--transition-curve) .3s forwards;opacity:0}#login-wall .login-logo{font-size:3rem;font-weight:800;margin-bottom:10px}#login-wall .section-subtitle{margin-bottom:40px}#discord-login-btn{font-size:1.1rem;padding:16px 36px}#discord-login-btn i{margin-right:12px}#welcome-transition.exiting{animation:slide-up-and-fade-out .8s var(--transition-curve) forwards}.welcome-message{text-align:center}.welcome-message h2{font-size:3rem;color:var(--color-heading)}.welcome-message .username{background:var(--primary-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
        #profile-modal{display:none;position:fixed;z-index:10001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.8);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}
        #profile-modal.visible{display:flex;align-items:center;justify-content:center;animation:fade-in .3s ease}.profile-modal-content{background:var(--color-background);border:1px solid var(--color-card-border);padding:40px;border-radius:var(--border-radius);max-width:800px;width:90%;position:relative;animation:modal-fade-in .5s var(--transition-curve)}.profile-modal-close{color:var(--color-text);float:right;font-size:28px;font-weight:700;position:absolute;top:15px;right:25px;transition:color .3s;cursor:pointer}.profile-modal-close:focus,.profile-modal-close:hover{color:var(--color-heading);outline:0}.profile-header{display:flex;align-items:center;gap:20px;margin-bottom:30px}#profile-modal-avatar{width:80px;height:80px;border-radius:50%}#profile-modal-username{font-size:2rem;font-weight:700;color:var(--color-heading)}.profile-stats{display:flex;gap:40px;margin-bottom:40px;padding-bottom:20px;border-bottom:1px solid var(--color-card-border)}.stat-item h4{font-size:.9rem;color:var(--color-text);opacity:.7;margin-bottom:5px;text-transform:uppercase;letter-spacing:1px}.stat-item p{font-size:1.2rem;font-weight:600;color:var(--color-heading)}#achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}.achievement-card{background:var(--color-card-bg);padding:20px;border-radius:12px;text-align:center;transition:all .3s ease;border:1px solid var(--color-card-border);position:relative}.achievement-card.locked{opacity:.4;filter:grayscale(80%)}.achievement-card.unlocked{transform:scale(1)}.achievement-card .icon{font-size:2.5rem;margin-bottom:15px}.achievement-card.unlocked .icon{background:var(--primary-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.achievement-card h5{font-size:1rem;color:var(--color-heading);margin-bottom:5px}.achievement-card p{font-size:.85rem;color:var(--color-text);opacity:.7;line-height:1.4}.new-badge{position:absolute;top:10px;right:10px;background-color:var(--color-status-up);color:#000;font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:10px}#cursor-glow{position:fixed;top:0;left:0;width:600px;height:600px;background:radial-gradient(circle,var(--color-glow) 0,transparent 70%);border-radius:50%;pointer-events:none;transform:translate(-50%,-50%);z-index:-1;transition:transform .2s ease-out,width .3s ease,height .3s ease}#cursor-glow.clicking{width:550px;height:550px}@media (pointer:coarse){#cursor-glow{display:none}}
        .btn{position:relative;display:inline-block;padding:14px 32px;border-radius:50px;text-decoration:none;font-weight:600;transition:all var(--transition-speed) var(--transition-curve);border:1px solid var(--color-card-border);cursor:pointer;white-space:nowrap;overflow:hidden;-webkit-backdrop-filter:blur(5px);backdrop-filter:blur(5px)}
        .btn-primary{background-image:var(--primary-gradient);color:#000;border-color:transparent;box-shadow:0 8px 30px -10px var(--color-glow)}.btn-primary:hover{transform:translateY(-4px) scale(1.05);box-shadow:0 12px 35px -8px var(--color-glow)}.btn-primary::before{content:'';position:absolute;top:0;left:-100%;width:75%;height:100%;transform:skewX(-25deg);background:linear-gradient(90deg,transparent 0,rgba(255,255,255,.7) 50%,transparent 100%);animation:btn-shine 1s ease-in-out 2.5s infinite}.btn-secondary{background-color:transparent;color:var(--color-heading);border-color:var(--color-heading)}.btn-secondary:hover{background-color:var(--color-heading);color:var(--color-background);transform:translateY(-4px) scale(1.05);box-shadow:0 0 15px -5px var(--color-heading)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;box-shadow:none!important}.content-section{padding:140px 5%;max-width:1280px;margin:0 auto;text-align:center}.section-title{font-size:3.5rem;font-weight:800;color:var(--color-heading);margin-bottom:20px;line-height:1.2;letter-spacing:-.02em}.section-subtitle{font-size:1.1rem;max-width:700px;margin:0 auto 80px auto;color:var(--color-text)}.gradient-text{background:var(--primary-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
        .card{background:var(--color-card-bg);border-radius:var(--border-radius);padding:40px;-webkit-backdrop-filter:blur(15px);backdrop-filter:blur(15px);border:1px solid var(--color-card-border);transform-style:preserve-3d;transition:transform .6s var(--transition-curve),box-shadow .6s var(--transition-curve)}
        .reveal-container{opacity:0;transition:opacity .8s ease}.reveal-container.is-visible{opacity:1}.reveal-child{opacity:0;transform:translateY(40px) scale(.98);transition:opacity .8s var(--transition-curve),transform .8s var(--transition-curve);transition-delay:calc(var(--i) * 100ms)}.reveal-container.is-visible .reveal-child{opacity:1;transform:translateY(0) scale(1)}
        .main-header{position:fixed;top:0;left:0;width:100%;z-index:1000;transition:background-color .3s ease,border-bottom-color .3s ease;height:var(--header-height);display:flex;align-items:center;border-bottom:1px solid transparent}
        .main-header.scrolled{background:rgba(5,5,5,.8);-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px);border-bottom-color:var(--color-card-border)}
        .navbar{display:flex;justify-content:space-between;align-items:center;width:100%;max-width:1400px;margin:0 auto;padding:0 5%}.nav-left{display:flex;align-items:center;gap:60px}.nav-actions{display:flex;align-items:center;gap:25px}.nav-actions .user-info-details{cursor:pointer}.logo-area{display:flex;align-items:center;gap:12px;text-decoration:none}.nav-logo{font-size:1.8rem;font-weight:800;color:var(--color-heading);text-decoration:none}.nav-menu{list-style:none;display:flex;gap:45px;align-items:center}.nav-link{color:var(--color-text);text-decoration:none;font-weight:600;transition:all .3s ease;position:relative;padding:5px 0}.nav-link::after{content:'';position:absolute;bottom:0;left:0;width:0;height:2px;background:var(--primary-gradient);transition:width .3s ease}.nav-link.active,.nav-link:hover{color:var(--color-heading)}.nav-link.active::after,.nav-link:hover::after{width:100%}.title-status-dot{width:10px;height:10px;border-radius:50%}body.status-up .title-status-dot{background-color:var(--color-status-up);animation:pulse-status 2s infinite}.game-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:30px}.game-card{background:var(--color-card-bg);border-radius:var(--border-radius);overflow:hidden;text-align:left;transition:all .3s ease;border:1px solid var(--color-card-border)}.game-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.3);border-color:var(--color-card-border-hover)}.game-card.coming-soon{opacity:.6;filter:grayscale(80%)}.game-card-thumbnail{position:relative}.game-card-thumbnail img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover;background-color:rgba(255,255,255,.02)}
        .coming-soon-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--color-heading);font-size:1.1rem;letter-spacing:1px;-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px)}
        .game-card-info{padding:20px}.game-card-info h3{color:var(--color-heading);font-size:1.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.game-card-info p{color:var(--color-text);opacity:.7;font-size:.9rem}.game-card-actions{padding:0 20px 20px;display:flex;gap:10px}.game-card-actions .btn{padding:8px 20px;font-size:.9rem}.user-info-details{display:flex;align-items:center;gap:15px}.user-avatar{width:40px;height:40px;border-radius:50%}.user-name{font-weight:600;color:var(--color-heading)}#cta-section{padding:120px 5%;background:0 0}#cta-section h2{font-size:3rem;margin-bottom:20px}.back-to-top{position:fixed;bottom:30px;right:30px;width:50px;height:50px;background-image:var(--primary-gradient);color:#000;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;text-decoration:none;opacity:0;visibility:hidden;transition:all .4s ease;z-index:999;transform:translateY(20px)}.back-to-top.visible{opacity:1;visibility:visible;transform:translateY(0)}.mobile-nav-container{display:none}@media (max-width:1024px){.navbar{display:flex;justify-content:space-between}.nav-left .nav-menu-container,.nav-actions{display:none}.mobile-nav-container{display:flex;align-items:center;gap:15px}.nav-left .logo-area{gap:0}.main-header .nav-left{flex-grow:1}.nav-menu{position:fixed;top:0;right:-100%;width:100%;height:100vh;flex-direction:column;justify-content:center;gap:40px;background-color:var(--color-background);transition:right .4s ease-in-out;z-index:1000;display:flex}.nav-menu.active{right:0}.hamburger{display:block;z-index:1001;cursor:pointer;padding:10px;background:0 0;border:none}.hamburger .bar{display:block;width:25px;height:3px;margin:5px auto;background-color:#fff;transition:all .3s ease-in-out;border-radius:2px}.hamburger.active .bar:nth-child(2){opacity:0;transform:translateX(-20px)}.hamburger.active .bar:nth-child(1){transform:translateY(8px) rotate(45deg)}.hamburger.active .bar:nth-child(3){transform:translateY(-8px) rotate(-45deg)}.section-title{font-size:2.5rem}.mobile-actions{display:flex;flex-direction:column;align-items:center;gap:20px;margin-top:20px}.game-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
        .api-status{text-align:center;padding:40px;font-style:italic;opacity:.7}.api-status.error{color:var(--color-status-down);opacity:1;font-weight:600}
        .games-page-header{padding-top:calc(var(--header-height) + 60px);padding-bottom:60px;text-align:center}.games-controls{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:20px;margin-bottom:50px;max-width:1200px;margin-left:auto;margin-right:auto;padding:0 5%}.search-bar{position:relative;min-width:250px;flex-grow:1;max-width:400px}.search-bar input{width:100%;padding:12px 15px 12px 45px;border-radius:8px;border:1px solid var(--color-card-border);background:var(--color-card-bg);color:var(--color-text);font-size:1rem;transition:all .3s}.search-bar input:focus{outline:0;border-color:var(--color-card-border-hover);box-shadow:0 0 10px var(--color-glow)}.search-bar::before{content:"\f002";font-family:"Font Awesome 6 Free";font-weight:900;position:absolute;left:18px;top:50%;transform:translateY(-50%);color:var(--color-text);opacity:.5}.filter-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}.filter-btn{background:var(--color-card-bg);border:1px solid var(--color-card-border);color:var(--color-text);padding:10px 20px;border-radius:8px;cursor:pointer;font-family:var(--font-family);font-weight:600;transition:all .3s}.filter-btn:hover{background:rgba(255,255,255,.1);color:var(--color-heading);transform:translateY(-2px)}.filter-btn.active{background-image:var(--primary-gradient);color:#000;border-color:transparent}
    </style>
</head>
<body class="state-preloading">

    <div id="preloader"><span class="preloader-logo gradient-text">Cerium</span></div>
    <div id="login-wall">
        <div class="login-container">
            <div class="login-card card">
                <h1 class="login-logo gradient-text">Cerium</h1>
                <p class="section-subtitle" style="margin-bottom: 40px;">Please connect with Discord to access the Cerium Hub.</p>
                <div id="login-status-message"></div>
                <button id="discord-login-btn" class="btn btn-primary"><i class="fab fa-discord"></i> Connect with Discord</button>
            </div>
        </div>
    </div>
    <div id="welcome-transition">
        <div class="welcome-message">
            <h2>Welcome, <span id="welcome-username" class="username"></span></h2>
        </div>
    </div>
    <div id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-modal-username">
        <div class="profile-modal-content">
            <button class="profile-modal-close" aria-label="Close profile modal">Ã—</button>
            <div class="profile-header">
                <img src="" alt="User Avatar" id="profile-modal-avatar">
                <h3 id="profile-modal-username"></h3>
            </div>
            <div class="profile-stats">
                <div class="stat-item"><h4>Member Since</h4><p id="profile-modal-join-date"></p></div>
                <div class="stat-item"><h4>Reports Submitted</h4><p id="profile-modal-report-count"></p></div>
                <div class="stat-item"><h4>Comments Posted</h4><p id="profile-modal-comment-count"></p></div>
            </div>
            <h3 style="margin-bottom: 20px;">Achievements</h3>
            <div id="achievements-grid"></div>
        </div>
    </div>

    <div id="main-content">
        <header class="main-header">
            <nav class="navbar">
                <div class="nav-left">
                    <a href="index.html" class="logo-area" aria-label="Cerium - Home">
                        <span class="nav-logo">Cerium</span>
                    </a>
                     <div class="nav-menu-container">
                        <ul class="nav-menu">
                            <li><a href="games.html" class="nav-link active">Games</a></li>
                            <li><a href="index.html#updates" class="nav-link">Updates</a></li>
                            <li><a href="index.html#staff" class="nav-link">Team</a></li>
                            <li><a href="index.html#bug-report" class="nav-link">Report</a></li>
                        </ul>
                    </div>
                </div>
                 <div class="mobile-nav-container">
                    <a href="index.html" class="logo-area" aria-label="Cerium - Home"><span class="title-status-dot"></span></a>
                    <button class="hamburger" aria-label="Open menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
                    <ul class="nav-menu">
                        <li><a href="games.html" class="nav-link active">Games</a></li>
                        <li><a href="index.html#updates" class="nav-link">Updates</a></li>
                        <li><a href="index.html#staff" class="nav-link">Team</a></li>
                        <li><a href="index.html#bug-report" class="nav-link">Report a Bug</a></li>
                        <li class="mobile-actions">
                            <div id="mobile-user-info" class="user-info-details" style="gap: 10px; margin-bottom: 20px;" tabindex="0" role="button" aria-label="Open profile">
                                <img src="" alt="User Avatar" id="mobile-nav-user-avatar" class="user-avatar">
                                <span id="mobile-nav-user-name" class="user-name"></span>
                            </div>
                            <a href="https://discord.gg/qjsGU83urz" target="_blank" class="btn btn-primary">Join Discord</a>
                            <button id="discord-logout-btn-mobile" class="btn btn-secondary" style="margin-top: 10px;">Logout</button>
                        </li>
                    </ul>
                </div>
                <div class="nav-actions">
                    <div id="header-user-info" class="user-info-details" style="gap: 10px;" tabindex="0" role="button" aria-label="Open profile">
                        <img src="" alt="User Avatar" id="nav-user-avatar" class="user-avatar">
                        <span id="nav-user-name" class="user-name"></span>
                    </div>
                    <button id="discord-logout-btn-header" class="btn btn-secondary">Logout</button>
                </div>
            </nav>
        </header>

        <main>
            <section class="games-page-header">
                <h1 class="section-title reveal-container"><span class="reveal-child">Our Games</span></h1>
                <p class="section-subtitle reveal-container" style="margin-bottom: 0;"><span class="reveal-child" style="--i: 1;">Search and filter through our entire library of supported products.</span></p>
            </section>
            
            <div class="games-controls reveal-container">
                <div class="search-bar reveal-child" style="--i: 2;">
                    <input type="text" id="game-search-input" placeholder="Search for a game...">
                </div>
                <div class="filter-buttons reveal-child" style="--i: 3;" id="game-filter-buttons">
                </div>
            </div>

            <section id="supported-games" class="content-section" style="padding-top: 0;">
                <div class="game-grid" id="game-grid-main">
                </div>
            </section>
        </main>
        
        <a href="#" class="back-to-top" aria-label="Back to top"><i class="fas fa-arrow-up"></i></a>
    </div>

    <script>
       document.addEventListener("DOMContentLoaded", function() {
    // --- CONFIGURATION ---
    const DISCORD_CLIENT_ID = "1397805094854197280";
    const REDIRECT_URI = window.location.origin + window.location.pathname.replace('games.html', '');
    const BUG_REPORT_RATE_LIMIT_MS = 60 * 60 * 1000;

    // --- DOM ELEMENTS ---
    const body = document.body;
    const preloader = document.getElementById('preloader');
    const welcomeTransition = document.getElementById('welcome-transition');
    const discordLoginBtn = document.getElementById('discord-login-btn');
    const profileModal = document.getElementById('profile-modal');
    const profileModalClose = document.querySelector('.profile-modal-close');
    const bugReportForm = document.getElementById('bug-report-form');
    const gameGrid = document.getElementById('game-grid-main');
    const searchInput = document.getElementById('game-search-input');
    const filterButtonsContainer = document.getElementById('game-filter-buttons');
    
    let allGamesData = [];

    // --- ACHIEVEMENT CONFIGURATION ---
    const ACHIEVEMENTS = {
        'welcome': { name: 'Welcome to the Hub', description: 'Successfully logged in.', icon: 'fas fa-door-open', condition: () => true },
        'first_report': { name: 'Bug Squasher', description: 'Submitted your first report.', icon: 'fas fa-bug', condition: (p) => p.reportCount >= 1 },
        'first_comment': { name: 'Community Voice', description: 'Posted your first comment.', icon: 'fas fa-comment-dots', condition: (p) => p.commentCount >= 1},
        'veteran': { name: 'Community Veteran', description: 'A member for over 30 days.', icon: 'fas fa-shield-alt', condition: (p) => (Date.now() - new Date(p.joinDate).getTime()) >= 30*24*60*60*1000 }
    };

    // --- HELPER FUNCTIONS ---
    const getProfileKey = (id) => `cerium_user_profile_${id}`;
    const getNewAchievementsKey = (id) => `cerium_new_achievements_${id}`;
    const getBugReportTimestampKey = (id) => `cerium_bug_report_ts_${id}`;
    const getCurrentUser = () => {
        try { return JSON.parse(localStorage.getItem('discord_user_v2')); } catch (e) { return null; }
    };

    // --- PROFILE & ACHIEVEMENT LOGIC ---
    function getOrCreateProfile(userData) {
        const key = getProfileKey(userData.id);
        let profile = JSON.parse(localStorage.getItem(key));
        if (!profile) {
            profile = { discordId: userData.id, joinDate: new Date().toISOString(), reportCount: 0, commentCount: 0, unlockedAchievements: [] };
            localStorage.setItem(key, JSON.stringify(profile));
            unlockAchievement(profile, 'welcome');
        }
        return profile;
    }

    function unlockAchievement(profile, id) {
        if (profile.unlockedAchievements.includes(id)) return;
        profile.unlockedAchievements.push(id);
        localStorage.setItem(getProfileKey(profile.discordId), JSON.stringify(profile));
        let newAchievements = JSON.parse(sessionStorage.getItem(getNewAchievementsKey(profile.discordId))) || [];
        if (!newAchievements.includes(id)) {
            newAchievements.push(id);
            sessionStorage.setItem(getNewAchievementsKey(profile.discordId), JSON.stringify(newAchievements));
        }
    }

    function checkAndUnlockAchievements(profile) {
        Object.keys(ACHIEVEMENTS).forEach(id => {
            if (!profile.unlockedAchievements.includes(id) && ACHIEVEMENTS[id].condition(profile)) {
               unlockAchievement(profile, id);
            }
        });
    }

    function displayProfileModal() {
        const user = getCurrentUser();
        if (!user || !profileModal) return;
        const profile = getOrCreateProfile(user);
        const newAchievements = JSON.parse(sessionStorage.getItem(getNewAchievementsKey(user.id))) || [];
        document.getElementById('profile-modal-avatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
        document.getElementById('profile-modal-username').textContent = `${user.username}#${user.discriminator}`;
        document.getElementById('profile-modal-join-date').textContent = new Date(profile.joinDate).toLocaleDateString();
        document.getElementById('profile-modal-report-count').textContent = profile.reportCount;
        document.getElementById('profile-modal-comment-count').textContent = profile.commentCount || 0;
        const grid = document.getElementById('achievements-grid');
        grid.innerHTML = Object.keys(ACHIEVEMENTS).map(id => {
            const ach = ACHIEVEMENTS[id];
            const isUnlocked = profile.unlockedAchievements.includes(id);
            const isNew = newAchievements.includes(id);
            return `<div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" title="${ach.description}">
                        ${isNew ? '<span class="new-badge">New!</span>' : ''}
                        <i class="icon ${ach.icon}"></i>
                        <h5>${ach.name}</h5>
                        <p>${ach.description}</p>
                    </div>`;
        }).join('');
        profileModal.classList.add('visible');
        body.classList.add('no-scroll');
    }

    function closeProfileModal() {
        if (!profileModal) return;
        profileModal.classList.remove('visible');
        body.classList.remove('no-scroll');
        const user = getCurrentUser();
        if (user) sessionStorage.removeItem(getNewAchievementsKey(user.id));
    }

    // --- PAGE STATE MANAGEMENT ---
    const setPageState = (state) => body.className = `state-${state}`;

    const showLoginWall = (message = null) => {
        if (message && document.getElementById('login-status-message')) {
            document.getElementById('login-status-message').textContent = message;
        }
        if (preloader) preloader.classList.add('hidden');
        setPageState('login');
    };
    
    // THIS FUNCTION IS NOW IN THE CORRECT SCOPE
    const handleLogout = () => {
        if (window.confirm("Are you sure you want to log out?")) {
            localStorage.removeItem('discord_user_v2');
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('cerium_')) localStorage.removeItem(key);
            });
            window.location.href = 'index.html';
        }
    };

    const showMainContent = (userData) => {
        const profile = getOrCreateProfile(userData);
        checkAndUnlockAchievements(profile);
        setPageState('authenticated');
        body.classList.add('status-up');
        initializePageScripts(userData);
    };

    const handleOAuthCallback = async () => {
        const fragment = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = fragment.get('access_token');
        const checkAndRedirect = async (user) => {
            try {
                const res = await fetch(`/api/check-user-status?userId=${user.id}`);
                const data = await res.json();
                if (data.status === 'banned') window.location.href = `/banned.html?reason=${encodeURIComponent(data.reason||'N/A')}`;
                else if (data.status === 'suspended') window.location.href = `/suspended.html?expires=${encodeURIComponent(data.expires)}&reason=${encodeURIComponent(data.reason||'N/A')}`;
                else return true;
                return false;
            } catch (e) { return true; }
        };

        if (accessToken) {
            try {
                const res = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } });
                if (!res.ok) throw new Error('Failed to fetch user data.');
                const userData = await res.json();
                if (!await checkAndRedirect(userData)) return;
                localStorage.setItem('discord_user_v2', JSON.stringify(userData));
                window.history.replaceState({}, document.title, window.location.pathname);
                fetch('/api/record-login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user: userData }) });
                if (welcomeTransition) {
                    document.getElementById('welcome-username').textContent = userData.username;
                    setPageState('welcome');
                    setTimeout(() => {
                        welcomeTransition.classList.add('exiting');
                        setTimeout(() => showMainContent(userData), 800);
                    }, 2000);
                } else {
                    showMainContent(userData);
                }
            } catch (error) {
                showLoginWall('Login failed. Please try again.');
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        } else {
            const storedUser = getCurrentUser();
            if (storedUser) {
                if (!await checkAndRedirect(storedUser)) return;
                setTimeout(() => showMainContent(storedUser), preloader ? 500 : 0);
            } else {
                showLoginWall();
            }
        }
    };
    
    // --- GAMES PAGE LOGIC ---
    function renderGames(gamesToRender) {
        if (!gameGrid) return;
        gameGrid.innerHTML = gamesToRender.length === 0 
            ? '<p class="api-status">No games found matching your criteria.</p>'
            : gamesToRender.map(game => {
                const isComingSoon = game.status?.trim().toLowerCase() === 'coming soon';
                return `<div class="game-card ${isComingSoon ? 'coming-soon' : ''}">
                            <div class="game-card-thumbnail">
                                <img src="${game.thumbnail_url || ''}" alt="${game.name} Thumbnail" onerror="this.style.display='none'">
                                ${isComingSoon ? '<div class="coming-soon-overlay">COMING SOON</div>' : ''}
                            </div>
                            <div class="game-card-info">
                                <h3>${game.name}</h3>
                                <p>${game.status}</p>
                            </div>
                            <div class="game-card-actions">
                                 <a href="#" class="btn btn-primary features-trigger" data-game-name="${game.name}" ${isComingSoon ? 'disabled' : ''}>View Details</a>
                            </div>
                        </div>`;
            }).join('');
    }

    function filterAndSearchGames() {
        if (!gameGrid) return;
        const searchTerm = searchInput.value.toLowerCase();
        const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
        let filteredGames = allGamesData;
        if (activeFilter !== 'All') {
            filteredGames = filteredGames.filter(game => game.status === activeFilter);
        }
        if (searchTerm) {
            filteredGames = filteredGames.filter(game => game.name.toLowerCase().includes(searchTerm));
        }
        renderGames(filteredGames);
    }

    async function loadGamesData() {
        if (allGamesData.length > 0) return allGamesData;
        try {
            const response = await fetch('/api/games');
            if (!response.ok) throw new Error('Server error');
            allGamesData = await response.json();
            return allGamesData;
        } catch (error) {
            console.error("Could not load games data:", error);
            if (gameGrid) gameGrid.innerHTML = `<p class="api-status error">Could not load games: ${error.message}</p>`;
            return [];
        }
    }
    
    // --- PAGE INITIALIZATION & EVENT LISTENERS ---
    async function initializePageScripts(userData) {
        const avatarUrl = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`;
        const userDisplay = `${userData.username}#${userData.discriminator}`;
        ['nav-user-avatar', 'mobile-nav-user-avatar'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.src = avatarUrl;
        });
        ['nav-user-name', 'mobile-nav-user-name'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = userDisplay;
        });

        const gamesData = await loadGamesData();

        if (gameGrid) {
            const statuses = ['All', ...new Set(gamesData.map(g => g.status).filter(Boolean))];
            filterButtonsContainer.innerHTML = statuses.map(status => 
                `<button class="filter-btn ${status === 'All' ? 'active' : ''}" data-filter="${status}">${status}</button>`
            ).join('');
            renderGames(gamesData);
            searchInput.addEventListener('input', filterAndSearchGames);
            filterButtonsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    document.querySelector('.filter-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    filterAndSearchGames();
                }
            });
        }
        
        if (bugReportForm) {
            const gameSelect = document.getElementById('game-select');
            gameSelect.innerHTML = '<option value="" disabled selected>Choose a game...</option>';
            gamesData.forEach(game => {
                 gameSelect.insertAdjacentHTML('beforeend', `<option value="${game.name}">${game.name}</option>`);
            });
            gameSelect.insertAdjacentHTML('beforeend', `<option value="Other">Other</option>`);
        }

        const backToTopButton = document.querySelector('.back-to-top');
        if (backToTopButton) {
            window.addEventListener('scroll', () => {
                backToTopButton.classList.toggle('visible', window.scrollY > 300);
            }, { passive: true });
        }
        
        const isReducedMotion = window.matchMedia(`(prefers-reduced-motion: reduce)`).matches;
        if (!isReducedMotion) {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('is-visible'); obs.unobserve(entry.target); } });
            }, { threshold: 0.1, rootMargin: "0px 0px -50px 0px" });
            document.querySelectorAll('.reveal-container').forEach(el => observer.observe(el));
        } else {
            document.querySelectorAll('.reveal-container').forEach(el => el.classList.add('is-visible'));
        }

        const hamburger = document.querySelector('.hamburger');
        const mobileNavMenu = document.querySelector('.mobile-nav-container .nav-menu');
        if (hamburger && mobileNavMenu) {
            const toggleMenu = () => {
                hamburger.classList.toggle('active');
                mobileNavMenu.classList.toggle('active');
                body.classList.toggle('no-scroll', hamburger.classList.contains('active'));
            };
            hamburger.addEventListener('click', toggleMenu);
            mobileNavMenu.querySelectorAll('a, button').forEach(el => el.addEventListener('click', () => {
                 if (hamburger.classList.contains('active')) toggleMenu(); 
            }));
        }

        ['header-user-info', 'mobile-user-info'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('click', displayProfileModal);
        });
        if(profileModalClose) profileModalClose.addEventListener('click', closeProfileModal);
        window.addEventListener('click', (event) => { if (event.target == profileModal) closeProfileModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && profileModal && profileModal.classList.contains('visible')) closeProfileModal(); });

        if (bugReportForm) {
            const reportSubmitBtn = document.getElementById('submit-bug-report');
            const reportStatusMsg = document.getElementById('form-status-message');
            const lastReportTime = parseInt(localStorage.getItem(getBugReportTimestampKey(userData.id)), 10);
            if (lastReportTime && (Date.now() - lastReportTime < BUG_REPORT_RATE_LIMIT_MS)) {
                reportSubmitBtn.disabled = true;
                const remainingTime = Math.ceil((BUG_REPORT_RATE_LIMIT_MS - (Date.now() - lastReportTime)) / (60 * 1000));
                reportStatusMsg.textContent = `You can submit another report in ${remainingTime} minute(s).`;
                reportStatusMsg.className = 'error';
            }
        }
    }
    
    // --- GLOBAL EVENT LISTENERS & INITIALIZATION ---
    if (bugReportForm) {
        bugReportForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submit-bug-report');
            const statusMessage = document.getElementById('form-status-message');
            const gameSelect = document.getElementById('game-select');
            const bugDesc = document.getElementById('bug-description');
            
            let isValid = true;
            [gameSelect, bugDesc].forEach(field => field.classList.remove('invalid'));
            statusMessage.textContent = ''; statusMessage.className = '';
            if (!gameSelect.value) { gameSelect.classList.add('invalid'); isValid = false; }
            if (!bugDesc.value.trim()) { bugDesc.classList.add('invalid'); isValid = false; }
            if (!isValid) {
                statusMessage.textContent = 'Please fill out all required fields.';
                statusMessage.className = 'error';
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            const userData = getCurrentUser();
            const discordPayload = {
                username: "Cerium Bug Reports",
                embeds: [{
                    author: { name: `Report by ${userData.username}#${userData.discriminator}`, icon_url: `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png` },
                    fields: [{ name: "Game", value: gameSelect.value }, { name: "Description", value: "```" + bugDesc.value.trim() + "```" }],
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                const response = await fetch('/api/bug-reports', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ discordPayload }) });
                if (!response.ok) throw new Error((await response.json()).error || 'Submission failed.');
                
                statusMessage.textContent = 'Report submitted successfully! Thank you.';
                statusMessage.className = 'success';
                setTimeout(() => { bugReportForm.reset(); statusMessage.textContent = ''; statusMessage.className = ''; }, 3000);
                
                const profile = getOrCreateProfile(userData);
                profile.reportCount = (profile.reportCount || 0) + 1;
                localStorage.setItem(getProfileKey(userData.id), JSON.stringify(profile));
                localStorage.setItem(getBugReportTimestampKey(userData.id), Date.now());
                checkAndUnlockAchievements(profile);
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                statusMessage.className = 'error';
                submitButton.disabled = false;
                submitButton.innerHTML = 'Submit Report';
            }
        });
    }

    if(discordLoginBtn) discordLoginBtn.addEventListener('click', () => window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`);
    document.getElementById('discord-logout-btn-header')?.addEventListener('click', handleLogout);
    document.getElementById('discord-logout-btn-mobile')?.addEventListener('click', handleLogout);

    handleOAuthCallback();
});
    </script>
</body>
</html>