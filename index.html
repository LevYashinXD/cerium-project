<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerium | The Athletic Standard for Roblox Sports</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-background: #050505;
            --color-heading: #FFFFFF;
            --color-text: #E0E0E0;
            --color-card-bg: rgba(255, 255, 255, 0.05);
            --color-card-border: rgba(255, 255, 255, 0.1);
            --color-card-border-hover: rgba(255, 255, 255, 0.2);
            --primary-gradient: linear-gradient(90deg, #FFFFFF, #888888);
            --color-glow: rgba(255, 255, 255, 0.3);
            --color-status-up: #00FF7F;
            --color-status-down: #FF3366;
            --color-status-caution: #FFD700;
            --header-height: 80px;
            --font-family: 'Inter', sans-serif;
            --border-radius: 16px;
            --transition-speed: 0.4s;
            --transition-curve: cubic-bezier(0.16, 1, 0.3, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; scroll-padding-top: var(--header-height); }
        body {
            font-family: var(--font-family); background-color: var(--color-background); color: var(--color-text);
            line-height: 1.7; overflow-x: hidden;
            background-image: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.04), transparent 35%), radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.04), transparent 35%);
            position: relative;
        }
        body.no-scroll { overflow: hidden; }
        
        @keyframes preloader-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        @keyframes reveal-up { from { opacity: 0; transform: translateY(50px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up-and-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-50px); } }
        @keyframes modal-fade-in { from { opacity: 0; transform: translateY(-20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        #preloader, #login-wall, #welcome-transition { display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background-color: var(--color-background); transition: opacity 0.5s ease, visibility 0.5s ease; }
        #login-wall, #welcome-transition, #main-content { opacity: 0; visibility: hidden; }
        body.state-preloading #preloader { opacity: 1; visibility: visible; }
        body.state-login #login-wall { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        body.state-welcome #welcome-transition { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        body.state-authenticated #main-content { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        #preloader.hidden { opacity: 0; visibility: hidden; }

        #preloader .preloader-logo { font-size: 2.5rem; font-weight: 800; color: var(--color-heading); animation: preloader-pulse 2s infinite ease-in-out; }
        #login-wall .login-container { text-align: center; max-width: 500px; padding: 20px; }
        #login-wall .login-card { padding: 50px 60px; animation: reveal-up 1s var(--transition-curve) 0.3s forwards; opacity: 0; }
        #discord-login-btn { font-size: 1.1rem; padding: 16px 36px; }
        #welcome-transition.exiting { animation: slide-up-and-fade-out 0.8s var(--transition-curve) forwards; }
        .welcome-message h2 { font-size: 3rem; color: var(--color-heading); }
        .welcome-message .username { background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }

        #profile-modal { display: none; position: fixed; z-index: 10001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        #profile-modal.visible { display: flex; align-items: center; justify-content: center; animation: fade-in 0.3s ease; }
        .profile-modal-content { background: var(--color-background); border: 1px solid var(--color-card-border); padding: 40px; border-radius: var(--border-radius); max-width: 800px; width: 90%; position: relative; animation: modal-fade-in 0.5s var(--transition-curve); }
        .profile-modal-close { color: var(--color-text); float: right; font-size: 28px; position: absolute; top: 15px; right: 25px; cursor: pointer; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; }
        #profile-modal-avatar { width: 80px; height: 80px; border-radius: 50%; }
        #profile-modal-username { font-size: 2rem; font-weight: 700; color: var(--color-heading); }
        .profile-stats { display: flex; gap: 40px; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--color-card-border); }
        .stat-item h4 { font-size: 0.9rem; opacity: 0.7; margin-bottom: 5px; text-transform: uppercase; }
        .stat-item p { font-size: 1.2rem; font-weight: 600; color: var(--color-heading); }
        #achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .achievement-card { background: var(--color-card-bg); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--color-card-border); }
        .achievement-card.locked { opacity: 0.4; filter: grayscale(80%); }
        .achievement-card .icon { font-size: 2.5rem; margin-bottom: 15px; }
        
        .btn { position: relative; display: inline-block; padding: 14px 32px; border-radius: 50px; text-decoration: none; font-weight: 600; border: 1px solid var(--color-card-border); cursor: pointer; }
        .btn-primary { background-image: var(--primary-gradient); color: #000; border-color: transparent; }
        .btn-secondary { background-color: transparent; color: var(--color-heading); border-color: var(--color-heading); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .content-section { padding: 140px 5%; max-width: 1280px; margin: 0 auto; text-align: center; }
        .section-title { font-size: 3.5rem; font-weight: 800; color: var(--color-heading); margin-bottom: 20px; }
        .section-subtitle { font-size: 1.1rem; max-width: 700px; margin: 0 auto 80px auto; color: var(--color-text); }
        .gradient-text { background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: var(--color-card-bg); border-radius: var(--border-radius); padding: 40px; border: 1px solid var(--color-card-border); }
        
        .main-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; height: var(--header-height); display: flex; align-items: center; border-bottom: 1px solid transparent; }
        .main-header.scrolled { background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(12px); border-bottom-color: var(--color-card-border); }
        .navbar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 5%; }
        .nav-left { display: flex; align-items: center; gap: 60px; }
        .nav-logo { font-size: 1.8rem; font-weight: 800; color: var(--color-heading); text-decoration: none; }
        .nav-menu { list-style: none; display: flex; gap: 45px; }
        .nav-link { color: var(--color-text); text-decoration: none; font-weight: 600; }
        .nav-actions { display: flex; align-items: center; gap: 25px; }
        .user-info-details { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .user-name { font-weight: 600; color: var(--color-heading); }

        .hero-section { min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; }
        .hero-content { max-width: 900px; position: relative; }
        .hero-title { font-size: clamp(3rem, 7vw, 5.5rem); font-weight: 800; color: var(--color-heading); line-height: 1.1; margin-bottom: 25px; }
        .hero-subtitle { font-size: 1.25rem; max-width: 650px; margin: 0 auto 40px; }
        .hero-buttons { display: flex; justify-content: center; gap: 20px; }

        .timeline-container { position: relative; max-width: 900px; margin: 0 auto; }
        .staff-list { display: flex; flex-direction: column; gap: 30px; max-width: 900px; margin: 0 auto; }
        #bug-report-form { max-width: 700px; margin: 40px auto 0; display: flex; flex-direction: column; gap: 20px; text-align: left; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--color-card-border); background: var(--color-card-bg); color: var(--color-text); font-size: 1rem; }
        .form-group textarea { resize: vertical; min-height: 120px; }
        #form-status-message { margin-top: 20px; text-align: center; }
        .back-to-top { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background-image: var(--primary-gradient); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; opacity: 0; visibility: hidden; transition: all 0.4s ease; z-index: 999; }
        .back-to-top.visible { opacity: 1; visibility: visible; }
        .mobile-nav-container { display: none; }
        @media (max-width: 1024px) { .mobile-nav-container { display: block; } .nav-left .nav-menu-container, .nav-actions { display: none; } }
    </style>
</head>
<body class="state-preloading">

    <div id="preloader"><span class="preloader-logo gradient-text">Cerium</span></div>
    <div id="login-wall">
        <div class="login-container">
            <div class="login-card card">
                <h1 class="gradient-text" style="font-size: 3rem; margin-bottom: 10px;">Cerium</h1>
                <p class="section-subtitle" style="margin-bottom: 40px;">Please connect with Discord to access the Cerium Hub.</p>
                <div id="login-status-message"></div>
                <button id="discord-login-btn" class="btn btn-primary"><i class="fab fa-discord"></i> Connect with Discord</button>
            </div>
        </div>
    </div>
    <div id="welcome-transition">
        <div class="welcome-message">
            <h2>Welcome, <span id="welcome-username" class="username"></span></h2>
        </div>
    </div>
    <div id="profile-modal" role="dialog" aria-modal="true" aria-labelledby="profile-modal-username">
        <!-- Profile modal content is unchanged -->
    </div>

    <div id="main-content">
        <header class="main-header">
            <!-- Header content is unchanged -->
        </header>

        <main>
            <!-- All main sections are unchanged -->
            <section id="welcome" class="hero-section"><!-- ... --></section>
            <section id="updates" class="content-section"><!-- ... --></section>
            <section id="staff" class="content-section"><!-- ... --></section>
            <section id="bug-report" class="content-section"><!-- ... --></section>
            <section id="cta-section" class="content-section"><!-- ... --></section>
        </main>
        <a href="#welcome" class="back-to-top"><i class="fas fa-arrow-up"></i></a>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const DISCORD_CLIENT_ID = "1397805094854197280";
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const body = document.body;
        const preloader = document.getElementById('preloader');
        const welcomeTransition = document.getElementById('welcome-transition');
        const discordLoginBtn = document.getElementById('discord-login-btn');
        const bugReportForm = document.getElementById('bug-report-form');
        const profileModal = document.getElementById('profile-modal');
        const profileModalClose = document.querySelector('.profile-modal-close');
        
        const ACHIEVEMENTS = {
            'welcome': { name: 'Welcome', description: 'Logged in for the first time.', icon: 'fas fa-door-open', condition: () => true },
            'first_report': { name: 'Bug Squasher', description: 'Submitted your first report.', icon: 'fas fa-bug', condition: (p) => p.reportCount >= 1 },
        };

        const getProfileKey = (id) => `cerium_user_profile_${id}`;
        const getCurrentUser = () => { try { return JSON.parse(localStorage.getItem('discord_user_v2')); } catch (e) { return null; } };

        function getOrCreateProfile(userData) {
            const profileKey = getProfileKey(userData.id);
            let profile = JSON.parse(localStorage.getItem(profileKey));
            if (!profile) {
                profile = { discordId: userData.id, joinDate: new Date().toISOString(), reportCount: 0, commentCount: 0, unlockedAchievements: [] };
                localStorage.setItem(profileKey, JSON.stringify(profile));
                unlockAchievement(profile, 'welcome');
            }
            return profile;
        }

        function unlockAchievement(profile, achievementId) {
            if (profile.unlockedAchievements.includes(achievementId)) return;
            profile.unlockedAchievements.push(achievementId);
            localStorage.setItem(getProfileKey(profile.discordId), JSON.stringify(profile));
        }

        function checkAndUnlockAchievements(profile) {
            Object.keys(ACHIEVEMENTS).forEach(id => {
                if (!profile.unlockedAchievements.includes(id) && ACHIEVEMENTS[id].condition(profile)) {
                   unlockAchievement(profile, id);
                }
            });
        }

        function displayProfileModal() {
            const userData = getCurrentUser();
            if (!userData) return;
            const profile = getOrCreateProfile(userData);
            document.getElementById('profile-modal-avatar').src = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`;
            document.getElementById('profile-modal-username').textContent = `${userData.username}`;
            document.getElementById('profile-modal-join-date').textContent = new Date(profile.joinDate).toLocaleDateString();
            document.getElementById('profile-modal-report-count').textContent = profile.reportCount;
            document.getElementById('profile-modal-comment-count').textContent = profile.commentCount || 0;
            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = '';
            Object.keys(ACHIEVEMENTS).forEach(id => {
                const isUnlocked = profile.unlockedAchievements.includes(id);
                grid.insertAdjacentHTML('beforeend', `<div class="achievement-card ${isUnlocked ? '' : 'locked'}"><i class="${ACHIEVEMENTS[id].icon} icon"></i><h5>${ACHIEVEMENTS[id].name}</h5></div>`);
            });
            profileModal.classList.add('visible');
            body.classList.add('no-scroll');
        }

        function closeProfileModal() {
            profileModal.classList.remove('visible');
            body.classList.remove('no-scroll');
        }

        const setPageState = (state) => body.className = `state-${state}`;

        const showLoginWall = () => {
            preloader.classList.add('hidden');
            setPageState('login');
        };

        const showWelcomeTransition = async (userData) => {
            document.getElementById('welcome-username').textContent = userData.username;
            preloader.classList.add('hidden');
            setPageState('welcome');
            await loadDataForForms();
            setTimeout(() => {
                welcomeTransition.classList.add('exiting');
                setTimeout(() => showMainContent(userData), 800);
            }, 2000);
        };

        const showMainContent = (userData) => {
            const profile = getOrCreateProfile(userData);
            checkAndUnlockAchievements(profile);
            setPageState('authenticated');
            initializePageScripts(userData);
        };

        const handleLogout = () => {
            if (confirm("Log out?")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        async function loadDataForForms() {
            const gameSelect = document.getElementById('game-select');
            try {
                const response = await fetch('/api/games');
                if (!response.ok) throw new Error('Server error');
                const games = await response.json();
                gameSelect.innerHTML = '<option value="" disabled selected>Choose a game...</option>';
                games.forEach(game => {
                    gameSelect.insertAdjacentHTML('beforeend', `<option value="${game.name}">${game.name}</option>`);
                });
                gameSelect.insertAdjacentHTML('beforeend', `<option value="Other">Other</option>`);
            } catch (error) { 
                gameSelect.innerHTML = `<option value="" disabled selected>Error</option>`;
            }
        }
        
        // --- NEW & IMPROVED AUTHENTICATION FLOW ---

        const checkAndRedirect = async (user) => {
            try {
                const response = await fetch(`/api/check-user-status?userId=${user.id}`);
                const data = await response.json();
                if (data.status === 'banned') {
                    const reasonQuery = data.reason ? `?reason=${encodeURIComponent(data.reason)}` : '';
                    window.location.href = `/banned.html${reasonQuery}`;
                    return false; 
                }
                if (data.status === 'suspended') {
                    const reasonQuery = data.reason ? `&reason=${encodeURIComponent(data.reason)}` : '';
                    const expiresQuery = data.expires ? `?expires=${encodeURIComponent(data.expires)}` : '';
                    window.location.href = `/suspended.html${expiresQuery}${reasonQuery}`;
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Failed to check user status:", error);
                return true; 
            }
        };

        const recordUserPresence = async (user) => {
            try {
                await fetch('/api/record-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user })
                });
            } catch (error) {
                console.warn("Failed to record user presence:", error);
            }
        };
        
        const handleOAuthCallback = async () => {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = fragment.get('access_token');

            if (accessToken) { // User is logging in for the first time
                try {
                    const res = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } });
                    const userData = await res.json();
                    localStorage.setItem('discord_user_v2', JSON.stringify(userData));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    if (!await checkAndRedirect(userData)) return; 
                    await recordUserPresence(userData);
                    
                    await showWelcomeTransition(userData);
                } catch (error) {
                    showLoginWall();
                }
            } else { // User is returning to the page or reloading
                const storedUser = getCurrentUser();
                if (storedUser) {
                    if (!await checkAndRedirect(storedUser)) return;
                    await recordUserPresence(storedUser);

                    // Skip the long welcome transition for returning users
                    preloader.classList.add('hidden');
                    await loadDataForForms();
                    showMainContent(storedUser);
                } else {
                    showLoginWall();
                }
            }
        };
        // --- END OF NEW AUTHENTICATION FLOW ---

        function initializePageScripts(userData) {
            const avatarUrl = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`;
            document.getElementById('nav-user-avatar').src = avatarUrl;
            document.getElementById('nav-user-name').textContent = userData.username;

            const header = document.querySelector('.main-header');
            const backToTopButton = document.querySelector('.back-to-top');
            window.addEventListener('scroll', () => {
                header.classList.toggle('scrolled', window.scrollY > 50);
                backToTopButton.classList.toggle('visible', window.scrollY > 300);
            }, { passive: true });

            document.getElementById('header-user-info').addEventListener('click', displayProfileModal);
            profileModalClose.addEventListener('click', closeProfileModal);
            
            const reportSubmitBtn = document.getElementById('submit-bug-report');
            const lastReportTime = parseInt(localStorage.getItem(`cerium_bug_report_ts_${userData.id}`), 10);
            if (lastReportTime && (Date.now() - lastReportTime < BUG_REPORT_RATE_LIMIT_MS)) {
                reportSubmitBtn.disabled = true;
                const remainingTime = Math.ceil((BUG_REPORT_RATE_LIMIT_MS - (Date.now() - lastReportTime)) / 60000);
                document.getElementById('form-status-message').textContent = `You can report again in ${remainingTime} min.`;
            }
        }
        
        bugReportForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submit-bug-report');
            const statusMessage = document.getElementById('form-status-message');
            const userData = getCurrentUser();
            const reportData = {
                userId: userData.id,
                username: userData.username,
                game: document.getElementById('game-select').value,
                description: document.getElementById('bug-description').value
            };
            
            submitButton.disabled = true;
            statusMessage.textContent = 'Submitting...';

            try {
                const response = await fetch('/api/bug-reports', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reportData }) });
                if (!response.ok) throw new Error('Submission failed.');
                statusMessage.textContent = 'Report submitted!';
                bugReportForm.reset();
                
                const profile = getOrCreateProfile(userData);
                profile.reportCount = (profile.reportCount || 0) + 1;
                localStorage.setItem(getProfileKey(userData.id), JSON.stringify(profile));
                localStorage.setItem(`cerium_bug_report_ts_${userData.id}`, Date.now());
                checkAndUnlockAchievements(profile);
            } catch (error) {
                statusMessage.textContent = `Error: ${error.message}`;
                submitButton.disabled = false;
            }
        });

        discordLoginBtn.addEventListener('click', () => window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`);
        document.getElementById('discord-logout-btn-header').addEventListener('click', handleLogout);

        handleOAuthCallback();
    });
    </script>
</body>
</html>