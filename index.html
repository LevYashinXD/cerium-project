<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerium | The Athletic Standard for Roblox Sports</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --color-background: #050505;
            --color-heading: #FFFFFF;
            --color-text: #E0E0E0;
            --color-card-bg: rgba(255, 255, 255, 0.05);
            --color-card-border: rgba(255, 255, 255, 0.1);
            --primary-gradient: linear-gradient(90deg, #FFFFFF, #888888);
            --color-glow: rgba(255, 255, 255, 0.3);
            --color-status-up: #00FF7F;
            --header-height: 80px;
            --font-family: 'Inter', sans-serif;
            --border-radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; scroll-padding-top: var(--header-height); }
        body { font-family: var(--font-family); background-color: var(--color-background); color: var(--color-text); line-height: 1.7; overflow-x: hidden; }
        body.no-scroll { overflow: hidden; }
        
        @keyframes preloader-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slide-up-and-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-50px); } }

        #preloader, #login-wall, #welcome-transition { display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background-color: var(--color-background); transition: opacity 0.5s ease; }
        #login-wall, #welcome-transition, #main-content { opacity: 0; visibility: hidden; }
        body.state-preloading #preloader { opacity: 1; visibility: visible; }
        body.state-login #login-wall { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        body.state-welcome #welcome-transition { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        body.state-authenticated #main-content { opacity: 1; visibility: visible; animation: fade-in 0.5s ease forwards; }
        #preloader.hidden { opacity: 0; visibility: hidden; }

        #preloader .preloader-logo { font-size: 2.5rem; font-weight: 800; animation: preloader-pulse 2s infinite ease-in-out; }
        #login-wall .login-card { padding: 50px 60px; }
        #discord-login-btn { font-size: 1.1rem; padding: 16px 36px; }
        #welcome-transition.exiting { animation: slide-up-and-fade-out 0.8s ease forwards; }
        .welcome-message h2 { font-size: 3rem; }
        .welcome-message .username { background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        
        .btn { display: inline-block; padding: 14px 32px; border-radius: 50px; text-decoration: none; font-weight: 600; border: 1px solid var(--color-card-border); cursor: pointer; }
        .btn-primary { background-image: var(--primary-gradient); color: #000; border-color: transparent; }
        .btn-secondary { background-color: transparent; color: var(--color-heading); border-color: var(--color-heading); }
        .content-section { padding: 140px 5%; max-width: 1280px; margin: 0 auto; text-align: center; }
        .section-title { font-size: 3.5rem; font-weight: 800; color: var(--color-heading); }
        .section-subtitle { font-size: 1.1rem; max-width: 700px; margin: 0 auto 80px auto; }
        .gradient-text { background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: var(--color-card-bg); border-radius: var(--border-radius); padding: 40px; border: 1px solid var(--color-card-border); }
        
        .main-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; height: var(--header-height); display: flex; align-items: center; border-bottom: 1px solid transparent; }
        .navbar { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 5%; }
        .nav-left { display: flex; align-items: center; gap: 60px; }
        .nav-logo { font-size: 1.8rem; font-weight: 800; color: var(--color-heading); text-decoration: none; }
        .nav-menu { list-style: none; display: flex; gap: 45px; }
        .nav-link { color: var(--color-text); text-decoration: none; font-weight: 600; }
        .nav-actions { display: flex; align-items: center; gap: 25px; }
        .user-info-details { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .user-name { font-weight: 600; color: var(--color-heading); }
        .hero-section { min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; }
        .hero-title { font-size: clamp(3rem, 7vw, 5.5rem); font-weight: 800; }
        .hero-subtitle { font-size: 1.25rem; max-width: 650px; margin: 40px auto; }
        .hero-buttons { display: flex; justify-content: center; gap: 20px; }
    </style>
</head>
<body class="state-preloading">

    <div id="preloader"><span class="preloader-logo gradient-text">Cerium</span></div>
    <div id="login-wall">
        <div class="login-card card">
            <h1 class="gradient-text" style="font-size: 3rem;">Cerium</h1>
            <p class="section-subtitle">Please connect with Discord to access the Cerium Hub.</p>
            <button id="discord-login-btn" class="btn btn-primary"><i class="fab fa-discord"></i> Connect with Discord</button>
        </div>
    </div>
    <div id="welcome-transition">
        <div class="welcome-message">
            <h2>Welcome, <span id="welcome-username" class="username"></span></h2>
        </div>
    </div>
    
    <div id="main-content">
        <header class="main-header">
            <nav class="navbar">
                <div class="nav-left">
                    <a href="#welcome" class="nav-logo">Cerium</a>
                     <ul class="nav-menu">
                        <li><a href="games.html" class="nav-link">Games</a></li>
                    </ul>
                </div>
                <div class="nav-actions">
                    <div id="header-user-info" class="user-info-details">
                        <img src="" alt="User Avatar" id="nav-user-avatar" class="user-avatar">
                        <span id="nav-user-name" class="user-name"></span>
                    </div>
                    <button id="discord-logout-btn-header" class="btn btn-secondary">Logout</button>
                </div>
            </nav>
        </header>

        <main>
            <section id="welcome" class="hero-section">
                <div>
                    <h1 class="hero-title">The "Athletic" <span class="gradient-text">Standard</span></h1>
                    <p class="hero-subtitle">Engineered for victory across Roblox's top competitive sports games.</p>
                    <div class="hero-buttons">
                        <a href="games.html" class="btn btn-primary">Explore Products</a>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const DISCORD_CLIENT_ID = "1397805094854197280";
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const body = document.body;
        const preloader = document.getElementById('preloader');
        const discordLoginBtn = document.getElementById('discord-login-btn');

        const setPageState = (state) => body.className = `state-${state}`;
        const getCurrentUser = () => JSON.parse(localStorage.getItem('discord_user_v2'));

        const handleLogout = () => {
            if (confirm("Are you sure you want to log out?")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        const showMainContent = (userData) => {
            setPageState('authenticated');
            initializePageScripts(userData); // This is where the event listeners will now be attached.
        };

        const showWelcomeTransition = async (userData) => {
            document.getElementById('welcome-username').textContent = userData.username;
            setPageState('welcome');
            setTimeout(() => {
                document.getElementById('welcome-transition').classList.add('exiting');
                setTimeout(() => showMainContent(userData), 800);
            }, 2000);
        };

        const checkAndRedirect = async (user) => {
            try {
                const response = await fetch(`/api/check-user-status?userId=${user.id}`);
                const data = await response.json();
                if (data.status === 'banned') {
                    window.location.href = `/banned.html?reason=${encodeURIComponent(data.reason || '')}`;
                    return false;
                }
                if (data.status === 'suspended') {
                    window.location.href = `/suspended.html?expires=${encodeURIComponent(data.expires || '')}&reason=${encodeURIComponent(data.reason || '')}`;
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Status check failed:", error);
                return true;
            }
        };

        const recordUserPresence = (user) => {
            fetch('/api/record-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user })
            }).catch(err => console.warn("Failed to record user presence:", err));
        };
        
        const handleOAuthCallback = async () => {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = fragment.get('access_token');

            if (accessToken) {
                try {
                    const res = await fetch('https://discord.com/api/users/@me', { headers: { authorization: `Bearer ${accessToken}` } });
                    const userData = await res.json();
                    localStorage.setItem('discord_user_v2', JSON.stringify(userData));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    if (!await checkAndRedirect(userData)) return; 
                    recordUserPresence(userData);
                    
                    await showWelcomeTransition(userData);
                } catch { setPageState('login'); }
            } else {
                const storedUser = getCurrentUser();
                if (storedUser) {
                    if (!await checkAndRedirect(storedUser)) return;
                    recordUserPresence(storedUser);
                    
                    preloader.classList.add('hidden');
                    showMainContent(storedUser);
                } else {
                    setPageState('login');
                }
            }
        };

        // --- THIS IS THE CORRECTED PART ---
        // This function now holds all the logic that needs to run AFTER the main content is visible.
        function initializePageScripts(userData) {
            // Update user info in the header
            document.getElementById('nav-user-avatar').src = `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.png`;
            document.getElementById('nav-user-name').textContent = userData.username;

            // --- EVENT LISTENERS ARE MOVED HERE ---
            const logoutButton = document.getElementById('discord-logout-btn-header');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
            
            // This is the fix for your bug report form error from the other day.
            // It will also prevent this error if that element ever gets removed.
            const bugReportForm = document.getElementById('bug-report-form');
            if (bugReportForm) {
                bugReportForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    // ... your bug report submission logic ...
                });
            }
        }
        
        // --- GLOBAL LISTENERS (that don't depend on main content) ---
        discordLoginBtn.addEventListener('click', () => { window.location.href = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`; });

        // --- START THE AUTHENTICATION PROCESS ---
        handleOAuthCallback();
    });
    </script>
</body>
</html>